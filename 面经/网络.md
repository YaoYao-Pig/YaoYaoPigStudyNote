https://blog.csdn.net/weixin_42565127/article/details/128537092

https://zhuanlan.zhihu.com/p/357973435

https://mp.weixin.qq.com/s?__biz=MjM5OTc2ODUxMw==&mid=2649723567&idx=2&sn=ec946eef347c5768f05a67160f1dfe97&scene=21#wechat_redirect

## 帧同步

### 问题

由于本身状态同步的服务器是作为一个转发的机制，因此他会默认悲观一致性，会要求达到一致性之后才转发。但是会出现网络不好的卡住网络好的情况。

#### 解决方法：

##### 1. 乐观帧锁定：处理帧同步中网络条件较差问题的技术

在帧同步的背景下，特别是在在线多人游戏中，当网络条件较差时，传统的帧同步方法可能会导致游戏卡顿或延迟。为了解决这一问题，**乐观帧锁定（Optimistic Frame Locking）** 提供了一种有效的技术手段。下面我们来详细解释这种技术如何处理网络条件较差的情况。

###### 什么是帧同步和网络条件较差的问题？

**帧同步（Frame Synchronization）** 是多人在线游戏中常用的一种技术，用于确保所有客户端在相同的游戏帧上保持一致的游戏状态。通常，这需要客户端在每一帧都发送和接收网络数据包。然而，当网络条件较差（例如高延迟或数据包丢失）时，客户端可能需要等待数据包到达才能继续游戏，这会导致明显的卡顿或延迟，影响玩家的体验。

###### 乐观帧锁定的核心思想

乐观帧锁定结合了 **帧锁定（Frame Locking）** 和 **乐观锁定（Optimistic Locking）** 的概念，旨在提高游戏的流畅性和响应性。它的核心思想是：

- **减少对网络的严格依赖**：客户端不再等待网络数据包到达，而是假设数据包会及时到达，继续渲染游戏帧。
- **动态调整状态**：如果网络延迟或数据包丢失导致游戏状态不一致，客户端会通过回滚或预测等手段进行调整。

这种方法类似于编程中的乐观锁定，即假设冲突（或网络问题）不常发生，只在问题发生时再处理。

###### 乐观帧锁定的工作原理

在网络条件较差的情况下，乐观帧锁定通过以下步骤解决问题：

1. **继续渲染**：客户端不因等待网络数据包而暂停，而是基于当前已知的状态继续运行游戏。
2. **检测与调整**：当网络数据包最终到达时，客户端会检查是否存在状态不一致。如果发现问题，可能回滚到之前的正确帧，或者通过预测未来的状态进行修正。
3. **资源优化**：通过减少不必要的等待和同步操作，降低对网络带宽和CPU的压力，提升游戏性能。

###### 为什么适用于网络条件较差的场景？

传统的帧锁定是“悲观”的，它要求客户端等待所有数据包到达以确保一致性，但在网络不稳定时会导致严重的延迟。而乐观帧锁定则更“乐观”，假设网络通常是可靠的，从而在大多数情况下提供更高的流畅性。只有在网络问题实际发生时，才通过动态调整来解决问题。这种灵活性特别适合网络条件较差的环境。

###### 应用场景

乐观帧锁定在以下场景中尤为有效：

- **在线多人游戏**：在网络不稳定时仍能提供较好的游戏体验。
- **实时竞技游戏**：需要快速响应和低延迟的游戏可以通过预测和调整保持流畅性。

###### 与传统帧锁定的区别

| 特性             | 传统帧锁定         | 乐观帧锁定                 |
| ---------------- | ------------------ | -------------------------- |
| **同步方式**     | 等待网络数据包到达 | 假设数据包会到达，继续运行 |
| **网络条件要求** | 需要稳定网络       | 适应较差网络条件           |
| **流畅性**       | 可能卡顿           | 更流畅                     |
| **一致性处理**   | 实时确保一致性     | 事后调整一致性             |

###### 总结

乐观帧锁定是一种专门针对帧同步中网络条件较差问题的技术。它通过减少对网络数据包的严格等待、动态调整游戏状态以及优化资源使用，为玩家提供更流畅的游戏体验。相比传统的帧锁定方法，它更灵活、更适应不稳定的网络环境。如果您对具体实现感兴趣，可以进一步查阅游戏引擎（如Unity或Unreal Engine）或网络编程的相关文档。

------



### 如果一致性存在问题，如何处理？通过回滚吗，回滚一般怎么做

在处理一致性问题时，尤其是在网络条件较差的情况下，比如帧同步游戏中，**回滚（Rollback）**是一种常用的技术手段。它可以帮助解决由于网络延迟或数据不同步导致的游戏状态不一致问题。下面我将详细解答一致性问题的处理方法，以及回滚的具体实现方式。

------

#### **一致性问题的处理：通过回滚**

当网络条件不佳时，例如在乐观帧锁定机制下，客户端可能会基于本地预测继续运行游戏，但如果后续接收到的网络数据与本地状态不符，就会出现一致性问题。为了解决这个问题，回滚技术允许客户端在检测到不一致时，回到之前的正确状态，并重新计算后续的游戏帧，从而恢复一致性。

------

#### **回滚的基本原理**

回滚的核心思想是：

- **保存历史状态**：客户端会记录最近几帧的游戏状态（比如玩家的位置、动作等）。
- **检测不一致**：通过比较本地状态和网络传来的状态，判断是否需要调整。
- **恢复与重计算**：如果发现不一致，就回退到最后一个正确的状态，然后重新计算后续帧。

------

#### **回滚的具体步骤**

回滚的实现通常包括以下步骤：

1. **保存快照**
    客户端在每一帧都会保存游戏状态的快照。这些快照包括关键数据，比如玩家的位置、速度、输入指令等，以便在需要时回溯。
2. **接收网络数据**
    当客户端收到服务器或其他客户端发来的数据包时，会将这些数据与本地保存的状态进行对比。
3. **检测冲突**
    如果本地状态与网络数据不一致（例如玩家位置不同或动作未同步），说明出现了冲突。
4. **回滚到一致状态**
    客户端会找到最后一个与网络数据一致的帧（通常是最近的正确状态），然后回退到这一帧。
5. **重计算后续帧**
    从回滚的帧开始，客户端利用网络数据和本地的输入指令，重新计算后续的游戏帧，直到恢复到正确的最新状态。

------

#### **回滚的优势**

- **流畅性**：即使网络延迟较高，客户端也能继续运行游戏，避免明显的卡顿。
- **一致性**：通过回滚和重计算，最终确保所有玩家的游戏状态一致。

#### **回滚的挑战**

- **计算开销**：回滚和重计算需要额外的性能支持，尤其在复杂游戏中。
- **视觉效果**：如果回滚频繁，玩家可能会注意到画面跳跃或不连贯。

------

#### **回滚的优化方法**

为了减少回滚的负面影响，可以结合以下方法：

- **预测（Prediction）**
   在等待网络数据时，客户端可以根据玩家的历史输入预测未来的状态，减少回滚的次数。
- **插值（Interpolation）**
   在回滚后，通过平滑过渡（比如位置插值）来改善视觉体验，避免突兀的变化。
- **限制回滚范围**
   只对受影响的部分（比如某个玩家）进行回滚，而不是整个游戏状态，从而降低计算负担。

------

#### **应用场景**

回滚技术在一些实时性要求高的游戏中非常有效，例如：

- **格斗游戏**：如《街头霸王》，通过回滚减少网络延迟对对战体验的影响。
- **实时战略游戏**：在网络不稳定时，保持多玩家的状态同步。

------

#### **总结**

如果一致性存在问题，回滚是一种非常有效的处理方法。它通过保存历史状态、检测冲突并重计算后续帧，确保游戏在网络条件较差时仍能保持流畅性和一致性。虽然回滚可能带来计算开销或视觉上的小瑕疵，但通过预测和插值等优化手段，可以显著提升体验。

## 状态同步

分两种，增量同步的RPC

1. 增量同步：

   https://gafferongames.com/post/state_synchronization/

   

https://medium.com/@qingweilim/how-do-multiplayer-games-sync-their-state-part-1-ab72d6a54043

https://mas-bandwidth.com/creating-a-first-person-shooter-that-scales-to-millions-of-players/